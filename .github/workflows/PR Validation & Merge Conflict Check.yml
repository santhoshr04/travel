name: PR Validation & Merge Conflict Check

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Base Branch (main)
        uses: actions/checkout@v3
        with:
          ref: main  # Checkout the main branch

      - name: Check Mergeability via GitHub API
        id: check_merge
        run: |
          PR_URL="${{ github.event.pull_request.url }}"
          MERGEABLE_STATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$PR_URL" | jq -r '.mergeable')

          echo "Mergeable State: $MERGEABLE_STATE"

          if [[ "$MERGEABLE_STATE" == "false" ]]; then
            echo "âŒ Merge conflicts detected!"
            echo "conflict=true" >> $GITHUB_ENV
            exit 1
          else
            echo "âœ… No conflicts detected!"
            echo "conflict=false" >> $GITHUB_ENV
          fi

      - name: Send Merge Conflict Notification to Discord
        if: env.conflict == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âŒ Merge Conflict Detected",
                   "description": "Resolve conflicts before merging.\n\nğŸ”— **PR:** [View PR](${{ github.event.pull_request.html_url }})\nğŸ‘¤ **Author:** ${{ github.event.pull_request.user.login }}",
                   "color": 16711680
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Send Success Notification to Discord
        if: env.conflict == 'false'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âœ… PR is Ready for Merge",
                   "description": "No merge conflicts found! ğŸ‰\n\nğŸ”— **PR:** [View PR](${{ github.event.pull_request.html_url }})\nğŸ‘¤ **Author:** ${{ github.event.pull_request.user.login }}",
                   "color": 65280
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}
