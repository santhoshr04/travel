name: PR Validation & Merge Conflict Check

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Check Mergeability via GitHub API
        id: check_merge
        run: |
          PR_URL="${{ github.event.pull_request.url }}"
          MERGEABLE_STATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$PR_URL" | jq -r '.mergeable')

          echo "Mergeable State: $MERGEABLE_STATE"

          if [[ "$MERGEABLE_STATE" == "false" ]]; then
            echo "âŒ Merge conflicts detected!"
            echo "conflict=true" >> $GITHUB_ENV
            exit 1
          else
            echo "âœ… No conflicts detected!"
            echo "conflict=false" >> $GITHUB_ENV
          fi

      - name: Send Merge Conflict Notification to Discord
        if: always()
        run: |
          if [[ "${{ env.conflict }}" == "true" ]]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d '{
                   "embeds": [{
                     "title": "âŒ Merge Conflict Detected",
                     "description": "**This pull request has merge conflicts and cannot be merged automatically.**\n\nPlease resolve the conflicts manually before proceeding.",
                     "fields": [
                       { "name": "ğŸ”— PR", "value": "[View PR](${{ github.event.pull_request.html_url }})", "inline": true },
                       { "name": "ğŸ‘¤ Author", "value": "${{ github.event.pull_request.user.login }}", "inline": true },
                       { "name": "ğŸ“Œ Title", "value": "${{ github.event.pull_request.title }}", "inline": false }
                     ],
                     "color": 16711680
                   }]
                 }' \
                 ${{ secrets.DISCORD_WEBHOOK }}
            exit 1  # Ensure the job fails if there are conflicts
          fi

      - name: Send Success Notification to Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âœ… PR is Ready for Merge",
                   "description": "**This pull request has no merge conflicts and is ready to be merged.**\n\nYou can proceed with the merge safely.",
                   "fields": [
                     { "name": "ğŸ”— PR", "value": "[View PR](${{ github.event.pull_request.html_url }})", "inline": true },
                     { "name": "ğŸ‘¤ Author", "value": "${{ github.event.pull_request.user.login }}", "inline": true },
                     { "name": "ğŸ“Œ Title", "value": "${{ github.event.pull_request.title }}", "inline": false }
                   ],
                   "color": 65280
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}
