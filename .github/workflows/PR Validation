name: PR Validation & Merge Conflict Check

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Check Mergeability via GitHub API
        id: check_merge
        run: |
          PR_URL="${{ github.event.pull_request.url }}"
          MERGEABLE_STATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$PR_URL" | jq -r '.mergeable')

          echo "Mergeable State: $MERGEABLE_STATE"

          if [[ "$MERGEABLE_STATE" == "false" ]]; then
            echo "‚ùå Merge conflicts detected!"
            echo "conflict=true" >> $GITHUB_ENV
            exit 1
          else
            echo "‚úÖ No conflicts detected!"
            echo "conflict=false" >> $GITHUB_ENV
          fi

      - name: Send Merge Conflict Notification to Discord
        if: always()
        run: |
          if [[ "${{ env.conflict }}" == "true" ]]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d '{
                   "embeds": [{
                     "title": "‚ùå Merge Conflict Detected",
                     "description": "Resolve conflicts before merging.\n\n **PR:** [View PR](${{ github.event.pull_request.html_url }})\n **Author:** ${{ github.event.pull_request.user.login }}  \n **Title:** ${{ github.event.pull_request.title }}",
                     "color": 16711680
                   }]
                 }' \
                 ${{ secrets.DISCORD_WEBHOOK }}
            exit 1  # Ensure the job fails if there are conflicts
          fi

      - name: Send Success Notification to Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "‚úÖ PR is Ready for Merge",
                   "description": "No merge conflicts found! üéâ\n\n **PR:** [View PR](${{ github.event.pull_request.html_url }})\n **Author:** ${{ github.event.pull_request.user.login }} \n **Title:** ${{ github.event.pull_request.title }}",
                   "color": 65280
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}
